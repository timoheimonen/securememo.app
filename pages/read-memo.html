<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read Secure Memo - securememo.app</title>
    <link rel="stylesheet" href="/styles.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="nav-logo">securememo.app</a>
            <ul class="nav-menu" id="navMenu">
                <li><a href="/" class="nav-link">Home</a></li>
                <li><a href="/about.html" class="nav-link">About</a></li>
                <li><a href="/create-memo.html" class="nav-link">Create Secure Memo</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="memo-container">
            <div class="memo-card">
                <h1>Read Secure Memo</h1>
                <p class="memo-description">Enter the password to decrypt and read the memo. It will be deleted after being read or expired.</p>
                
                <div id="passwordForm" class="memo-form">
                    <form id="decryptForm">
                        <div class="form-group">
                            <label for="password">Encryption Password</label>
                            <input type="text" id="password" name="password" required 
                                   placeholder="Enter the encryption password from the URL hashtag">
                            <small class="form-help">The password is in the URL hashtag (after the # symbol)</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Decrypt Memo</button>
                    </form>
                </div>
                
                <div id="memoContent" class="memo-content" style="display: none;">
                    <h3>üìù Your Secure Memo</h3>
                    <div class="memo-message">
                        <p id="decryptedMessage"></p>
                    </div>
                    <div class="memo-info">
                        <p><strong>Status:</strong> <span id="memoStatus">Memo has been read and deleted</span></p>
                    </div>
                    <div class="memo-actions">
                        <a href="/create-memo.html" class="btn btn-primary">Create New Memo</a>
                        <a href="/" class="btn btn-secondary">Go Home</a>
                    </div>
                </div>
                
                <div id="errorContent" class="error-content" style="display: none;">
                    <h3>‚ùå Error</h3>
                    <p id="errorMessage"></p>
                    <div class="memo-actions">
                        <a href="/create-memo.html" class="btn btn-primary">Create New Memo</a>
                        <a href="/" class="btn btn-secondary">Go Home</a>
                    </div>
                </div>
                
                <div id="message" class="message"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p><a href="https://github.com/timoheimonen/securememo.app" target="_blank" rel="noopener noreferrer">View source code at GitHub</a> | <a href="/tos.html">Terms of Service</a></p>
    </footer>

    <script>
        // API endpoint - using relative URLs since Pages will proxy to Workers
        const API_BASE_URL = '';

        function highlightCurrentPage() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
        }

        // Get memo ID from URL
        function getMemoId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Get password from URL hashtag
        function getPasswordFromHash() {
            return window.location.hash.substring(1);
        }

        // Decrypt message using Web Crypto API
        async function decryptMessage(encryptedData, password) {
            try {
                const encoder = new TextEncoder();
                
                // Decode the encrypted data
                const encryptedBytes = new Uint8Array(
                    atob(encryptedData).split('').map(char => char.charCodeAt(0))
                );
                
                // Extract salt (first 16 bytes), IV (next 12 bytes), and encrypted data
                const salt = encryptedBytes.slice(0, 16);
                const iv = encryptedBytes.slice(16, 28);
                const encrypted = encryptedBytes.slice(28);
                
                // Derive key from password
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(password),
                    { name: 'PBKDF2' },
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                const key = await crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt: salt,
                        iterations: 100000,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    false,
                    ['decrypt']
                );
                
                // Decrypt the data
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: iv },
                    key,
                    encrypted
                );
                
                return new TextDecoder().decode(decrypted);
            } catch (error) {
                throw new Error('Failed to decrypt message. Invalid password or corrupted data.');
            }
        }

        // Auto-fill password from URL hashtag if available
        window.addEventListener('load', () => {
            const passwordFromHash = getPasswordFromHash();
            if (passwordFromHash) {
                document.getElementById('password').value = passwordFromHash;
            }
            
            // Add form submission event listener after DOM is loaded
            const passwordForm = document.getElementById('decryptForm');
            if (passwordForm) {
                passwordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const password = document.getElementById('password').value.trim();
                    const memoId = getMemoId();
                    
                    if (!password) {
                        showError('Please enter the encryption password');
                        return;
                    }
                    
                    if (!memoId) {
                        showError('Invalid memo URL');
                        return;
                    }
                    
                    try {
                        // Fetch the encrypted memo from API (Pages will proxy to Workers)
                        const response = await fetch(`/api/read-memo?id=${memoId}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok) {
                            // Decrypt the message
                            const decryptedMessage = await decryptMessage(result.encryptedMessage, password);
                            
                            // Display the message
                            document.getElementById('decryptedMessage').textContent = decryptedMessage;
                            document.getElementById('memoContent').style.display = 'block';
                            document.getElementById('passwordForm').style.display = 'none';
                            
                            // Clear the password field
                            document.getElementById('password').value = '';
                            
                            // The memo is automatically deleted by the server after reading
                        } else {
                            if (result.error === 'Memo not found') {
                                showError('This memo has already been read and deleted, or it has expired.');
                            } else if (result.error === 'Memo expired') {
                                showError('This memo has expired and has been deleted.');
                            } else {
                                showError(result.error || 'Failed to read memo');
                            }
                        }
                    } catch (error) {
                        if (error.message.includes('Failed to decrypt')) {
                            showError('Invalid password. Please check the password from the URL hashtag.');
                        } else {
                            showError('An error occurred while reading the memo');
                        }
                        console.error('Error:', error);
                    }
                });
            }
        });

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorContent').style.display = 'block';
            document.getElementById('passwordForm').style.display = 'none';
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = 'message ' + type;
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        highlightCurrentPage();
    </script>
</body>
</html> 